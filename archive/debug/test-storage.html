<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test StorageManager</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üß™ Test StorageManager</h1>

    <div class="test-section">
        <h2>1. Initialisation</h2>
        <button onclick="testInit()">Tester Init</button>
        <div id="init-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Auth Storage</h2>
        <button onclick="testAuthSet()">Set Auth</button>
        <button onclick="testAuthGet()">Get Auth</button>
        <button onclick="testAuthClear()">Clear Auth</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h2>3. User-Scoped Data</h2>
        <input type="email" id="test-email" placeholder="test@example.com" value="user1@test.com">
        <button onclick="testUserDataSet()">Set User Data</button>
        <button onclick="testUserDataGet()">Get User Data</button>
        <button onclick="testUserDataClear()">Clear User Data</button>
        <div id="user-data-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Cache Collision Test</h2>
        <button onclick="testCacheCollision()">Test Multi-User Cache</button>
        <div id="collision-result"></div>
    </div>

    <div class="test-section">
        <h2>5. Temporary Storage</h2>
        <button onclick="testTempSet()">Set Temp</button>
        <button onclick="testTempGet()">Get Temp</button>
        <div id="temp-result"></div>
    </div>

    <div class="test-section">
        <h2>6. Stats</h2>
        <button onclick="showStats()">Show Stats</button>
        <button onclick="testCleanup()">Cleanup Expired</button>
        <div id="stats-result"></div>
    </div>

    <script src="src/storage-manager.js"></script>
    <script>
        let storage;

        async function testInit() {
            const result = document.getElementById('init-result');
            try {
                if (!window.storageManager) {
                    result.innerHTML = '<p class="error">‚ùå StorageManager not loaded!</p>';
                    return;
                }

                await window.storageManager.init();
                storage = window.storageManager;

                result.innerHTML = `
          <p class="success">‚úÖ StorageManager initialized</p>
          <pre>${JSON.stringify({
                    ready: storage.ready,
                    useIndexedDB: storage.useIndexedDB,
                    dbName: storage.dbName,
                    dbVersion: storage.dbVersion
                }, null, 2)}</pre>
        `;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testAuthSet() {
            const result = document.getElementById('auth-result');
            try {
                await storage.set('auth', {
                    token: 'test-token-' + Date.now(),
                    email: 'test@example.com',
                    discordUsername: 'TestUser#1234',
                    discordId: '123456789'
                }, { persist: true });

                result.innerHTML = '<p class="success">‚úÖ Auth data set</p>';
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testAuthGet() {
            const result = document.getElementById('auth-result');
            try {
                const auth = await storage.get('auth');
                result.innerHTML = `
          <p class="success">‚úÖ Auth data retrieved</p>
          <pre>${JSON.stringify(auth, null, 2)}</pre>
        `;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testAuthClear() {
            const result = document.getElementById('auth-result');
            try {
                await storage.remove('auth');
                result.innerHTML = '<p class="success">‚úÖ Auth data cleared</p>';
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testUserDataSet() {
            const result = document.getElementById('user-data-result');
            const email = document.getElementById('test-email').value;

            try {
                await storage.set('userStats', {
                    total: 10,
                    public: 7,
                    private: 3,
                    timestamp: Date.now()
                }, {
                    scope: email,
                    ttl: 5 * 60 * 1000,
                    persist: true
                });

                result.innerHTML = `<p class="success">‚úÖ User data set for ${email}</p>`;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testUserDataGet() {
            const result = document.getElementById('user-data-result');
            const email = document.getElementById('test-email').value;

            try {
                const data = await storage.get('userStats', { scope: email });
                result.innerHTML = `
          <p class="success">‚úÖ User data retrieved for ${email}</p>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testUserDataClear() {
            const result = document.getElementById('user-data-result');
            const email = document.getElementById('test-email').value;

            try {
                const removed = await storage.clearUserData(email);
                result.innerHTML = `<p class="success">‚úÖ Cleared ${removed} items for ${email}</p>`;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testCacheCollision() {
            const result = document.getElementById('collision-result');

            try {
                // Set data for user 1
                await storage.set('userStats', {
                    user: 'user1',
                    total: 10
                }, {
                    scope: 'user1@test.com',
                    ttl: 60000,
                    persist: true
                });

                // Set data for user 2
                await storage.set('userStats', {
                    user: 'user2',
                    total: 20
                }, {
                    scope: 'user2@test.com',
                    ttl: 60000,
                    persist: true
                });

                // Get data for each user
                const data1 = await storage.get('userStats', { scope: 'user1@test.com' });
                const data2 = await storage.get('userStats', { scope: 'user2@test.com' });

                const collision = data1.total === data2.total;

                result.innerHTML = `
          <p class="${collision ? 'error' : 'success'}">
            ${collision ? '‚ùå CACHE COLLISION DETECTED!' : '‚úÖ No cache collision'}
          </p>
          <p>User 1 data:</p>
          <pre>${JSON.stringify(data1, null, 2)}</pre>
          <p>User 2 data:</p>
          <pre>${JSON.stringify(data2, null, 2)}</pre>
        `;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testTempSet() {
            const result = document.getElementById('temp-result');

            try {
                await storage.set('tempData', {
                    message: 'This is temporary',
                    timestamp: Date.now()
                }, { temporary: true });

                result.innerHTML = '<p class="success">‚úÖ Temp data set</p>';
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testTempGet() {
            const result = document.getElementById('temp-result');

            try {
                const data = await storage.get('tempData');
                result.innerHTML = `
          <p class="success">‚úÖ Temp data retrieved</p>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function showStats() {
            const result = document.getElementById('stats-result');

            try {
                const stats = storage.getStats();
                result.innerHTML = `
          <p class="success">‚úÖ Stats</p>
          <pre>${JSON.stringify(stats, null, 2)}</pre>
        `;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testCleanup() {
            const result = document.getElementById('stats-result');

            try {
                const removed = await storage.cleanup();
                result.innerHTML = `<p class="success">‚úÖ Cleanup removed ${removed} expired items</p>`;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        // Auto-init on load
        window.addEventListener('DOMContentLoaded', async () => {
            await testInit();
        });
    </script>
</body>

</html>