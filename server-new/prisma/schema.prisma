// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Modèle User (utilisateurs Discord)
model User {
  id            String   @id @default(uuid())
  discordId     String   @unique
  username      String
  discriminator String?
  avatar        String?
  email         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  reviews  Review[]
  sessions Session[]
  likes    ReviewLike[]

  @@map("users")
}

// Modèle Session (authentification)
model Session {
  id        String   @id @default(uuid())
  sid       String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Modèle Review (reviews cannabis)
model Review {
  id          String   @id @default(uuid())
  holderName  String // Nom de la variété
  type        String // Indica, Sativa, Hybride, CBD
  description String?
  
  // Notation
  note        Float?
  ratings     String? // JSON: {apparence: 8, odeur: 9, gout: 7, effets: 8.5}
  
  // Profil terpénique et tags
  terpenes    String? // JSON: ["Myrcène", "Limonène", "Pinène"]
  tastes      String? // JSON: ["Citron", "Terreux", "Pin"]
  aromas      String? // JSON: ["Citron", "Boisé", "Fruité"]
  effects     String? // JSON: ["Relaxant", "Euphorique", "Créatif"]
  
  // Type de variété
  strainType  String? // "Indica Pur", "Hybride Indica", "Équilibré", "Hybride Sativa", "Sativa Pur"
  indicaRatio Int?    // 0-100 (0 = Sativa pur, 100 = Indica pur)
  
  // Champs spécifiques Hash/Concentré/Comestible
  cultivarsList        String? // JSON: Array de cultivars utilisés
  pipelineExtraction   String? // JSON: Pipeline d'extraction
  pipelineSeparation   String? // JSON: Pipeline de séparation
  purgevide            Boolean? // Purge à vide pour extraits solvants
  hashmaker            String? // Nom du hash maker
  breeder              String? // Breeder de la graine
  farm                 String? // Farm productrice
  cultivars            String? // Nom du/des cultivar(s)
  extraData            String? // JSON: Autres données dynamiques
  
  // Section Touché - Fleur
  toucheDensite        Float? // Densité /10
  toucheFriabilite     Float? // Friabilité /10
  toucheElasticite     Float? // Élasticité /10
  toucheHumidite       Float? // Humidité /10
  
  // Section Touché - Hash
  toucheTexture        String? // Texture (Poudreuse, Sableuse, etc.)
  toucheMalleabilite   Float? // Malléabilité /10
  toucheCollant        Float? // Collant /10
  toucheFragilite      Float? // Fragilité /10
  
  // Section Touché - Concentré
  toucheViscosite      Float? // Viscosité /10
  toucheStabilite      Float? // Stabilité /10
  
  // Notes d'intensité/piquant
  aromasPiquant        Float? // Piquant des odeurs /10
  aromasIntensity      Float? // Intensité des odeurs /10
  tastesIntensity      Float? // Intensité des goûts /10
  goutIntensity        Float? // Intensité gustative (Comestible) /10
  effectsIntensity     Float? // Intensité des effets /10
  
  // --- NOUVEAUX CHAMPS LEGACY ---
  
  // Plan cultural (Fleur)
  typeCulture          String? // Type de culture (Indoor, Outdoor, etc.)
  spectre              String? // Spectre lumineux (HPS, LED, etc.)
  substratSysteme      String? // Substrat & système cultural
  techniquesPropagation String? // Techniques de propagation
  engraisOrganiques    String? // Engrais organiques utilisés
  engraisMineraux      String? // Engrais minéraux utilisés
  additifsStimulants   String? // Additifs & stimulants
  
  // Visuel avancé
  densite              Float? // Densité visuelle /10
  trichome             Float? // Trichomes /10
  pistil               Float? // Pistils /10
  manucure             Float? // Manucure /10
  moisissure           Float? // Moisissure (10=aucune) /10
  graines              Float? // Graines (10=aucune) /10
  couleurTransparence  Float? // Couleur/transparence (Hash/Concentré) /10
  pureteVisuelle       Float? // Pureté visuelle (Hash/Concentré) /10
  couleur              Float? // Couleur (Concentré) /10
  viscosite            Float? // Viscosité (Concentré) /10
  melting              Float? // Melting (Concentré) /10
  residus              Float? // Résidus (Concentré) /10
  
  // Odeurs détaillées
  intensiteAromatique  Float? // Intensité aromatique /10
  notesDominantesOdeur String? // JSON: Notes dominantes (max 7)
  notesSecondairesOdeur String? // JSON: Notes secondaires (max 7)
  fideliteCultivars    Float? // Fidélité au cultivars (Hash/Concentré) /10
  
  // Texture détaillée
  durete               Float? // Dureté /10
  densiteTexture       Float? // Densité texture /10
  elasticite           Float? // Élasticité (Fleur) /10
  collant              Float? // Collant /10
  friabiliteViscosite  Float? // Friabilité/Viscosité (Hash) /10
  meltingResidus       Float? // Melting/Résidus (Hash) /10
  aspectCollantGras    Float? // Aspect collant/gras (Hash) /10
  viscositeTexture     Float? // Viscosité texture (Concentré) /10
  
  // Goûts & Expérience fumée
  dryPuff              String? // JSON: Notes dry puff (max 7)
  inhalation           String? // JSON: Notes inhalation (max 7)
  expiration           String? // JSON: Notes expiration/arrière-goût (max 7)
  intensiteFumee       Float? // Intensité fumée /10
  agressivite          Float? // Agressivité/piquant /10
  cendre               Float? // Cendre /10
  textureBouche        Float? // Texture en bouche (Concentré) /10
  douceur              Float? // Douceur/Agressivité (Concentré) /10
  intensite            Float? // Intensité générale (Concentré) /10
  
  // Effets détaillés
  montee               Float? // Montée (rapidité) /10
  intensiteEffet       Float? // Intensité des effets /10
  intensiteEffets      Float? // Alias pour Concentré /10
  typeEffet            String? // Type d'effet (textarea)
  dureeEffet           String? // Durée des effets (select)
  
  // Pipelines
  purificationPipeline  String? // JSON: [{id, name, details}, ...] (Hash & Concentré)
  fertilizationPipeline String? // JSON: [{id, name, phase, dose, frequency}, ...] (Fleur)
  substratMix           String? // JSON: [{id, substrat, percentage}, ...] (Fleur)
  
  // Recette (Comestible) - Structure unifiée
  recipe                String? // JSON: {ingredients: [{id, type: 'standard'|'cannabis', name, quantity, unit, ...}], protocol: [{id, action, details, ingredients: [ids]}]} (Comestible)
  
  // Images
  images      String? // JSON: ["image1.jpg", "image2.jpg", ...]
  mainImage   String? // Image principale
  
  // Métadonnées
  isPublic    Boolean  @default(true)
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Auteur
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  // Likes
  likes       ReviewLike[]

  @@index([authorId])
  @@index([type])
  @@index([createdAt])
  @@map("reviews")
}

// Modèle ReviewLike (likes/dislikes des reviews)
model ReviewLike {
  id        String   @id @default(uuid())
  reviewId  String
  userId    String
  isLike    Boolean  // true = like, false = dislike
  createdAt DateTime @default(now())

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // Un utilisateur ne peut liker/disliker qu'une fois
  @@index([reviewId])
  @@index([userId])
  @@map("review_likes")
}

// Template model for Orchard templates and custom layouts
model Template {
  id         String   @id @default(uuid())
  name       String
  description String?
  ownerId    String
  isPublic   Boolean  @default(false)
  // Store template configuration as JSON string to remain compatible with sqlite
  config     String
  thumbnail  String?  // optional path to a generated thumbnail image
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([ownerId])
  @@map("templates")
}
