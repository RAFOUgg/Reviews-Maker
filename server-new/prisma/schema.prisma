// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Modèle User (utilisateurs multi-OAuth)
model User {
  id            String   @id @default(uuid())
  
  // OAuth Providers (au moins un requis)
  discordId     String?  @unique
  googleId      String?  @unique
  appleId       String?  @unique
  amazonId      String?  @unique
  facebookId    String?  @unique
  
  // Infos de base
  username      String
  discriminator String?  // Discord uniquement
  avatar        String?
  email         String?

  // Auth locale (email/mot de passe)
  passwordHash  String?
  
  // Email backup authentication
  emailBackup   String?  @unique
  emailVerified Boolean  @default(false)
  
  // TOTP 2FA (optionnel)
  totpSecret    String?
  totpEnabled   Boolean  @default(false)
  
  // Conformité légale
  birthdate     DateTime?
  country       String?  // Code ISO (FR, US, CA, etc.)
  region        String?  // État/Province (pour US, CA)
  legalAge      Boolean  @default(false)
  consentRDR    Boolean  @default(false)
  consentDate   DateTime?
  
  // Rôles & permissions (JSON array: ["consumer", "influencer", "producer", "admin"])
  roles         String   @default("{\"roles\":[\"consumer\"]}")
  isBanned      Boolean  @default(false)
  bannedAt      DateTime?
  banReason     String?
  
  // Préférences utilisateur
  locale        String   @default("fr")  // "fr", "en", "es", "de"
  theme         String   @default("violet-lean")
  defaultExportTemplate String?  // ID du template préféré
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  reviews             Review[]
  sessions            Session[]
  likes               ReviewLike[]
  subscription        Subscription?
  influencerProfile   InfluencerProfile?
  producerProfile     ProducerProfile?
  reportsSubmitted    Report[] @relation("Reporter")
  reportsReceived     Report[] @relation("ReportedUser")

  @@index([email])
  @@index([discordId])
  @@index([googleId])
  @@index([appleId])
  @@index([emailBackup])
  @@map("users")
}

// Modèle Session (authentification)
model Session {
  id        String   @id @default(uuid())
  sid       String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Modèle Review (reviews cannabis)
model Review {
  id          String   @id @default(uuid())
  holderName  String // Nom de la variété
  type        String // Indica, Sativa, Hybride, CBD
  description String?
  
  // Notation
  note        Float?
  ratings     String? // JSON: {apparence: 8, odeur: 9, gout: 7, effets: 8.5}
  categoryRatings String? // JSON: {visual, smell, texture, taste, effects, overall}
  
  // Profil terpénique et tags
  terpenes    String? // JSON: ["Myrcène", "Limonène", "Pinène"]
  tastes      String? // JSON: ["Citron", "Terreux", "Pin"]
  aromas      String? // JSON: ["Citron", "Boisé", "Fruité"]
  effects     String? // JSON: ["Relaxant", "Euphorique", "Créatif"]
  
  // Type de variété
  strainType  String? // "Indica Pur", "Hybride Indica", "Équilibré", "Hybride Sativa", "Sativa Pur"
  indicaRatio Int?    // 0-100 (0 = Sativa pur, 100 = Indica pur)
  
  // Champs spécifiques Hash/Concentré/Comestible
  cultivarsList        String? // JSON: Array de cultivars utilisés
  pipelineExtraction   String? // JSON: Pipeline d'extraction
  pipelineSeparation   String? // JSON: Pipeline de séparation
  purgevide            Boolean? // Purge à vide pour extraits solvants
  hashmaker            String? // Nom du hash maker
  breeder              String? // Breeder de la graine
  farm                 String? // Farm productrice
  cultivars            String? // Nom du/des cultivar(s)
  extraData            String? // JSON: Autres données dynamiques
  
  // Section Touché - Fleur
  toucheDensite        Float? // Densité /10
  toucheFriabilite     Float? // Friabilité /10
  toucheElasticite     Float? // Élasticité /10
  toucheHumidite       Float? // Humidité /10
  
  // Section Touché - Hash
  toucheTexture        String? // Texture (Poudreuse, Sableuse, etc.)
  toucheMalleabilite   Float? // Malléabilité /10
  toucheCollant        Float? // Collant /10
  toucheFragilite      Float? // Fragilité /10
  
  // Section Touché - Concentré
  toucheViscosite      Float? // Viscosité /10
  toucheStabilite      Float? // Stabilité /10
  
  // Notes d'intensité/piquant
  aromasPiquant        Float? // Piquant des odeurs /10
  aromasIntensity      Float? // Intensité des odeurs /10
  tastesIntensity      Float? // Intensité des goûts /10
  goutIntensity        Float? // Intensité gustative (Comestible) /10
  effectsIntensity     Float? // Intensité des effets /10
  
  // --- NOUVEAUX CHAMPS LEGACY ---
  
  // Plan cultural (Fleur)
  typeCulture          String? // Type de culture (Indoor, Outdoor, etc.)
  spectre              String? // Spectre lumineux (HPS, LED, etc.)
  substratSysteme      String? // Substrat & système cultural
  techniquesPropagation String? // Techniques de propagation
  engraisOrganiques    String? // Engrais organiques utilisés
  engraisMineraux      String? // Engrais minéraux utilisés
  additifsStimulants   String? // Additifs & stimulants
  
  // Visuel avancé
  densite              Float? // Densité visuelle /10
  trichome             Float? // Trichomes /10
  pistil               Float? // Pistils /10
  manucure             Float? // Manucure /10
  moisissure           Float? // Moisissure (10=aucune) /10
  graines              Float? // Graines (10=aucune) /10
  couleurTransparence  Float? // Couleur/transparence (Hash/Concentré) /10
  pureteVisuelle       Float? // Pureté visuelle (Hash/Concentré) /10
  couleur              Float? // Couleur (Concentré) /10
  viscosite            Float? // Viscosité (Concentré) /10
  melting              Float? // Melting (Concentré) /10
  residus              Float? // Résidus (Concentré) /10
  
  // Odeurs détaillées
  intensiteAromatique  Float? // Intensité aromatique /10
  notesDominantesOdeur String? // JSON: Notes dominantes (max 7)
  notesSecondairesOdeur String? // JSON: Notes secondaires (max 7)
  fideliteCultivars    Float? // Fidélité au cultivars (Hash/Concentré) /10
  
  // Texture détaillée
  durete               Float? // Dureté /10
  densiteTexture       Float? // Densité texture /10
  elasticite           Float? // Élasticité (Fleur) /10
  collant              Float? // Collant /10
  friabiliteViscosite  Float? // Friabilité/Viscosité (Hash) /10
  meltingResidus       Float? // Melting/Résidus (Hash) /10
  aspectCollantGras    Float? // Aspect collant/gras (Hash) /10
  viscositeTexture     Float? // Viscosité texture (Concentré) /10
  
  // Goûts & Expérience fumée
  dryPuff              String? // JSON: Notes dry puff (max 7)
  inhalation           String? // JSON: Notes inhalation (max 7)
  expiration           String? // JSON: Notes expiration/arrière-goût (max 7)
  intensiteFumee       Float? // Intensité fumée /10
  agressivite          Float? // Agressivité/piquant /10
  cendre               Float? // Cendre /10
  textureBouche        Float? // Texture en bouche (Concentré) /10
  douceur              Float? // Douceur/Agressivité (Concentré) /10
  intensite            Float? // Intensité générale (Concentré) /10
  
  // Effets détaillés
  montee               Float? // Montée (rapidité) /10
  intensiteEffet       Float? // Intensité des effets /10
  intensiteEffets      Float? // Alias pour Concentré /10
  typeEffet            String? // Type d'effet (textarea)
  dureeEffet           String? // Durée des effets (select)
  
  // Pipelines
  purificationPipeline  String? // JSON: [{id, name, details}, ...] (Hash & Concentré)
  fertilizationPipeline String? // JSON: [{id, name, phase, dose, frequency}, ...] (Fleur)
  substratMix           String? // JSON: [{id, substrat, percentage}, ...] (Fleur)
  
  // Recette (Comestible) - Structure unifiée
  recipe                String? // JSON: {ingredients: [{id, type: 'standard'|'cannabis', name, quantity, unit, ...}], protocol: [{id, action, details, ingredients: [ids]}]} (Comestible)
  
  // Images
  images      String? // JSON: ["image1.jpg", "image2.jpg", ...]
  mainImage   String? // Image principale
  
  // Métadonnées
  isPublic    Boolean  @default(true)
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Auteur
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  // Relations
  likes       ReviewLike[]
  reports     Report[]

  @@index([authorId])
  @@index([type])
  @@index([createdAt])
  @@index([isPublic])
  @@map("reviews")
}

// Modèle ReviewLike (likes/dislikes des reviews)
model ReviewLike {
  id        String   @id @default(uuid())
  reviewId  String
  userId    String
  isLike    Boolean  // true = like, false = dislike
  createdAt DateTime @default(now())

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // Un utilisateur ne peut liker/disliker qu'une fois
  @@index([reviewId])
  @@index([userId])
  @@map("review_likes")
}

// Template model for Orchard templates and custom layouts
model Template {
  id          String   @id @default(uuid())
  name        String
  description String?
  ownerId     String
  isPublic    Boolean  @default(false)
  isPremium   Boolean  @default(false)  // Template réservé aux comptes premium (Influencer/Producer)
  
  // Catégorisation
  category    String   @default("custom")  // "predefined", "custom", "shared"
  templateType String  @default("standard") // "compact", "detailed", "complete", "custom"
  
  // Format et configuration
  format      String   @default("1:1")     // "1:1", "16:9", "9:16", "A4"
  maxPages    Int      @default(1)         // Nombre max de pages (pagination)
  
  // Store template configuration as JSON string to remain compatible with sqlite
  // Structure: { pages: [{ zones: [{ source, x, y, w, h, style }] }], theme, colors, fonts }
  config      String
  
  // Preview
  thumbnail   String?  // optional path to a generated thumbnail image
  
  // Permissions par type de compte
  // Format JSON: { "consumer": true, "influencer_basic": true, "influencer_pro": true, "producer": true }
  allowedAccountTypes String @default("{\"consumer\":true,\"influencer_basic\":true,\"influencer_pro\":true,\"producer\":true}")
  
  // Export capabilities
  // Format JSON: { "png": true, "jpeg": true, "pdf": false, "svg": false, "maxQuality": 150 }
  exportOptions String @default("{\"png\":true,\"jpeg\":true,\"pdf\":false,\"svg\":false,\"maxQuality\":150}")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
  @@index([category])
  @@index([isPublic])
  @@index([isPremium])
  @@map("templates")
}

// Partage de templates via code unique
model TemplateShare {
  id          String   @id @default(uuid())
  templateId  String
  shareCode   String   @unique  // Code unique de partage (ex: "ABCD1234")
  createdBy   String   // ID de l'utilisateur qui partage
  
  // Statistiques
  usedCount   Int      @default(0)
  maxUses     Int?     // Limite d'utilisations (null = illimité)
  
  // Validité
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())

  @@index([shareCode])
  @@index([templateId])
  @@index([createdBy])
  @@map("template_shares")
}

// ====================
// NOUVEAUX MODÈLES MVP
// ====================

// Abonnements Stripe
model Subscription {
  id                   String    @id @default(uuid())
  userId               String    @unique
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Stripe IDs
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?
  
  // Plan & Status
  plan                 String    // "free", "influencer_basic", "influencer_pro", "producer", "merchant"
  status               String    // "active", "canceled", "past_due", "trialing"
  
  // Billing
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  
  // Timestamps
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  
  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
  @@map("subscriptions")
}

// Profils Influenceur (mode Orchard)
model InfluencerProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Branding
  brandName     String?  // Nom de marque pour exports
  brandLogo     String?  // URL logo
  brandColors   String?  // JSON: {"primary": "#hex", "secondary": "#hex"}
  
  // Vérification
  isVerified    Boolean  @default(false)
  verifiedAt    DateTime?
  
  // Stats publiques
  followerCount Int?     // Compteur followers (externe)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("influencer_profiles")
}

// Profils Producteur (phase 2, structure préparée)
model ProducerProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Informations légales
  companyName     String
  siret           String?  // France
  ein             String?  // USA
  country         String
  
  // Vérification
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  verificationDoc String?  // URL document justificatif
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("producer_profiles")
}

// Signalements (modération)
model Report {
  id             String   @id @default(uuid())
  
  // Cible du signalement
  reviewId       String?
  userId         String?  // User signalé (si report de profil)
  
  // Auteur du signalement
  reporterId     String
  
  // Relations
  review         Review?  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reportedUser   User?    @relation("ReportedUser", fields: [userId], references: [id], onDelete: Cascade)
  reporter       User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  
  // Détails
  reason         String   // "spam", "inappropriate", "copyright", "illegal", "other"
  details        String?  // Description optionnelle
  status         String   @default("pending")  // "pending", "reviewed", "resolved", "dismissed"
  
  // Modération
  moderatedBy    String?  // ID admin qui a traité
  moderatedAt    DateTime?
  moderationNote String?  // Note interne
  
  // Timestamps
  createdAt      DateTime @default(now())
  
  @@index([reviewId])
  @@index([userId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
  @@map("reports")
}

// Journal d'audit (traçabilité actions critiques)
model AuditLog {
  id          String   @id @default(uuid())
  
  // Acteur (null si action système)
  userId      String?
  
  // Action
  action      String   // "review.delete", "user.ban", "report.resolve", "subscription.created"
  entityType  String?  // "review", "user", "report", "subscription"
  entityId    String?  // ID de l'entité concernée
  
  // Détails (JSON)
  metadata    String?  // JSON: détails action (ex: {"reason": "spam", "oldValue": "...", "newValue": "..."})
  
  // Contexte technique
  ipAddress   String?
  userAgent   String?
  
  // Timestamp
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}
